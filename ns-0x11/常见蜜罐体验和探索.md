# 常见蜜罐体验和探索

## 实验目的

- 了解蜜罐的分类和基本原理
- 了解不同类型蜜罐的适用场合
- 掌握常见蜜罐的搭建和使用

## 实验环境

- 从`paralax/awesome-honeypots`中选择**1**种低交互蜜罐和**1**种中等交互蜜罐进行搭建实验 (**推荐 SSH 蜜罐**)
- 网络拓朴结构
- 一台`victim`和一台`attacker`，均使用`NAT Network`
        <img src="imgs/topology.png" width=70%>
        <img src="imgs/NATnetwowrk.png" width=70%>

## 实验要求

- [x] 记录蜜罐的详细搭建过程；
- [x] 使用`nmap`扫描搭建好的蜜罐并分析扫描结果，同时分析「 nmap 扫描期间」蜜罐上记录得到的信息；
- [x] 如何辨别当前目标是一个「蜜罐」？以自己搭建的蜜罐为例进行说明；
- [ ] （可选）总结常见的蜜罐识别和检测方法；
- [ ] （可选）基于 canarytokens 搭建蜜信实验环境进行自由探索型实验

## 实验过程

### 低交互蜜罐 「 SSH Honeypot 」

#### 蜜罐搭建

- 从[paralax/awesome-honeypots](https://github.com/paralax/awesome-honeypots)中选择低交互蜜罐ssh-honeypot
- 在`Kali-victim`下
- 将参考资料的仓库克隆到本地
- 宿主机到虚拟机的`ssh`服务的现在端口为22，而蜜罐的端口默认为22，所以修改虚拟机的`ssh`的配置文件`vi /etc/ssh/sshd_config`的端口为其他不冲突端口23，`service ssh restart`重启ssh服务`，宿主机和虚拟机重新进行ssh连接 存疑`
        
    <img src="imgs/modifyport.png" width=70%>
- 安装docker并启动

        ```bash
        apt update && apt-get install docker docker-compose
        # 更新包管理器并且安装docker
        service docker start
        systemctl start docker
        # 启动docker
        ```
- 搭建蜜罐  
    进入`ssh-honeyport`文件夹中
    ```bash
    apt install libssh-dev libjson-c-dev
    # Make sure libssh and libjson-c are installed
    make
    ssh-keygen -t rsa -f ./ssh-honeypot.rsa
    bin/ssh-honeypot -r ./ssh-honeypot.rsa
    # Build and Run
    bin/ssh-honeypot -h
    # Usage
    ```
    
    <img src="imgs/sshhoneyportstart.png" width=70%>

#### 蜜罐测试
- 攻击者尝试连靶机，无法连接，用靶机的``查看日志文件，下面换了一个靶机做实验（实验结果类似的）


#### 使用`nmap`扫描搭建好的蜜罐并分析扫描结果
- TCP connect scan、TCP stealth scan、XMAS scan、FIN scan、NULL scan

    ```bash
    nmap -sT -P 22 -T4 -n -vv 10.0.2.5
    -sS TCP SYN scan
    -sT TCP connect scan
    -sX -sF -sN TCP Xmas, FIN, NULL scans
    -T<0-5>: Set timing template (higher is faster)
    -n/-R: Never do DNS resolution/Always resolve [default: sometimes]
    -v: Increase verbosity level (use -vv or more for greater effect)
    ```

### 中等交互蜜罐 「 Cowrie SSH Honeypot 」

#### 蜜罐搭建

- 从[paralax/awesome-honeypots](https://github.com/paralax/awesome-honeypots)中选择中等交互蜜罐cowrie ssh honeypot
- [在docker下的环境搭建文档](https://github.com/cowrie/cowrie#docker)
- 安装 cowrie
    ```bash
    # 这个方法真的很难装
    # 在Kali-victim下，确保已经安装了docker
    apt update && apt install docker-compose  
    # 安装docker
    git clone https://github.com/cowrie/docker-cowrie.git
    cd docker-cowrie/
    make all  
    # build all the images 
    docker-compose up -d
    # 运行cowrie
    ```

    ```bash
    # 考虑另外一个方法，在gitclone后
    cd docker-cowrie/   
    docker pull cowrie/cowrie
    docker run -p 2222:2222 cowrie/cowrie
    # 运行cowrie    
    ``` 
    <img src="imgs/cowrieinstall.png" width=70%>

    <img src="imgs/cowirerun.png" width=70%>

#### 测试蜜罐
- 在运行`cowrie`后，攻击者主机尝试连接靶机，以`root`用户的身份无论密码输入什么内容都可以成功登陆(除root以外的不行)，同时在靶机的日志文件中可以看到攻击者主机的操作，登陆时输入的密码什么的都可以被记录下来。
  ```
  # 攻击者连接靶机
  docker exec -it <docker name> tail -F /cowrie/cowrie-git/var/log/cowrie/cowrie.json
  # 靶机查看日志文件
  # 由docker ps 查看<docker name> 一定是要运行了cowrie才可以查看
  ```
  <img src="imgs/cowrietest.gif">
- 暴露一：一段时间后蜜罐会自行断连。但日志信息中会记录`"message":"Connection lost after 181 seconds"`，每次断连后，都会显示此消息。
      
  <img src="imgs/cowrietest.png" width=70%>
- 暴露二：ping操作
  - `ping www.baidu.com`的IP地址和宿主机上的IP地址不同
  - 响应时间相同，原则上每次ping应该为随机

      <img src="imgs/cowriepingerror.png">

- 暴露三：成功连接后，攻击者主机输入命令`curl www.baidu.com`，当`curl 要访问的网址`应该获得页面源代码，此处报错。
      
  <img src="imgs/curlerror.png" width=70%>

  试试其他命令，例如无法保存文件源代码，无法识别查看访问页面的命令。
  <img src="imgs/curlerror1.png" width=70%>

- 暴露四：wget(非交互式的网络文件下载工具)
  - 无帮助文档
  - 能够正常下载文件
  - 退出，再次连接靶机后，无刚才下载的文件
  <img src="imgs/cowriewget.gif">

#### 使用`nmap`扫描搭建好的蜜罐并分析扫描结果
- TCP connect scan、TCP stealth scan、XMAS scan、FIN scan、NULL scan，只有`TCP connect scan`的时候发现蜜罐记录的日志文件，在扫描的时候不仅有22端口，还有2222端口（暴露的可能性）
    
    <img src="imgs/cowrienmap.gif">

## 实验问题与解决

1. ssh honeyport的实验中，攻击者尝试连主机，一直都连的上

    <img src="imgs/sshsuccess.png" width=70%>

- 分析是honey port没搭好
- 网络问题？

## 实验总结

## 参考资料